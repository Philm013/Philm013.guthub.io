<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student Remote</title>
    <!-- PeerJS for WebRTC networking -->
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <!-- HTML5-QRCode for scanning teacher's screen -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Patrick+Hand&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for consistent theming */
        :root { --accent: #6366f1; --bg: #f8fafc; --font-hand: 'Patrick Hand', cursive; }
        
        /* Reset and Base Styles */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline:none; touch-action: manipulation; }
        body { margin:0; font-family:'Nunito',sans-serif; background:var(--bg); display:flex; flex-direction:column; height:100vh; overflow:hidden; }
        
        /* Screen Management: Only the .active screen is displayed */
        .screen { flex:1; padding:20px; display:none; flex-direction:column; align-items:center; overflow-y:auto; width:100%; }
        .screen.active { display:flex; }
        
        /* UI Components: Cards, Buttons, Inputs */
        .card { background:white; border-radius:20px; padding:20px; width:100%; max-width:400px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); text-align:center; margin-bottom: 20px; flex-shrink: 0; }
        .btn { width:100%; padding:14px; border-radius:12px; border:none; background:var(--accent); color:white; font-weight:800; font-size:1rem; margin-bottom:10px; cursor:pointer; transition:0.1s; }
        .btn:active { transform:scale(0.98); }
        .btn-s { background:#e2e8f0; color:#475569; }
        input, textarea { width:100%; padding:12px; border:2px solid #cbd5e1; border-radius:8px; font-size:1rem; margin-bottom:10px; font-family:inherit; }
        
        /* Avatar Grid Styling */
        .grid-av { display:grid; grid-template-columns:repeat(5,1fr); gap:5px; margin-bottom:15px; }
        .av { padding:10px; font-size:1.5rem; background:#f1f5f9; border-radius:8px; cursor:pointer; }
        .av.sel { background:#e0e7ff; border:2px solid var(--accent); }
        
        /* Note Type Selection Grid */
        .type-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%; }
        .type-btn { padding:15px; border-radius:12px; font-weight:700; cursor:pointer; display:flex; flex-direction:column; align-items:center; border:2px solid transparent; transition:0.2s; }
        .type-btn.selected { transform: scale(0.95); border-color: rgba(0,0,0,0.2); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        
        /* History List Styling */
        #hist-list { width: 100%; display: flex; flex-direction: column; gap: 12px; padding-bottom: 40px; }
        .note-card { 
            padding: 16px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; text-align: left; position: relative;
            font-family: var(--font-hand); font-size: 1.2rem; line-height: 1.3; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 6px solid transparent; background: white; display: flex; flex-direction: column; gap: 8px;
        }
        /* Semantic Note Colors */
        .n-notice, .n-claim { background: #fef3c7; border-left-color: #d97706; }
        .n-wonder, .n-evidence { background: #bae6fd; border-left-color: #0284c7; }
        .n-idea, .n-reasoning { background: #bbf7d0; border-left-color: #16a34a; }
        .n-test { background: #fecaca; border-left-color: #dc2626; }
        .n-meta { background: #ffffff; border-left-color: #64748b; border: 1px solid #e2e8f0; border-left-width: 6px; }
        .n-sketch { background: #ffffff; border-left-color: #64748b; border: 1px solid #e2e8f0; border-left-width: 6px; }

        .note-card.selected { outline: 3px solid var(--accent); transform: scale(1.02); z-index:10; }
        
        /* Note Controls (Edit/Delete) */
        .hist-bar { display: flex; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.05); }
        .icon-btn { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); background: rgba(255,255,255,0.5); cursor: pointer; font-size: 1.1rem; }
        .drag-h { position: absolute; right: 10px; top: 10px; color: rgba(0,0,0,0.3); font-size: 1.5rem; cursor: grab; }
        .dragging { opacity: 0.5; }

        /* Discussion Mode Styles */
        .disc-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .disc-controls { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px; margin-top: 10px; }
        .disc-btn { padding: 8px; font-size: 0.8rem; border-radius: 8px; border: 1px solid #cbd5e1; background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .disc-btn.active { background: #e0e7ff; border-color: var(--accent); color: var(--accent); }
        .disc-counter { font-size: 0.9rem; font-weight: 800; color: #64748b; background: #f1f5f9; padding: 4px 12px; border-radius: 12px; }

        /* Canvas / Sketching Styles */
        #sketch-canvas { border: 2px dashed #cbd5e1; border-radius: 12px; touch-action: none; background: white; cursor: crosshair; }
        .tool-row { display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; }
        .tool-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #e2e8f0; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }
        .tool-btn.active { border-color: var(--accent); background: #e0e7ff; color: var(--accent); }

        /* Exit Ticket Styles */
        .emoji-row { display:flex; justify-content:space-between; margin:20px 0; }
        .emoji-btn { font-size:2.5rem; background:transparent; border:none; cursor:pointer; opacity:0.5; transition:0.2s; transform:scale(1); }
        .emoji-btn.selected { opacity:1; transform:scale(1.3); }
        .mc-btn { width:100%; padding:15px; margin-bottom:10px; border:2px solid #cbd5e1; background:white; border-radius:12px; font-weight:bold; cursor:pointer; transition:0.2s; }
        .mc-btn.selected { border-color:var(--accent); background:#e0e7ff; color:var(--accent); }
        .badge-notify { position:absolute; top:-5px; right:-5px; width:20px; height:20px; background:#ef4444; border-radius:50%; color:white; font-size:0.8rem; display:flex; align-items:center; justify-content:center; font-weight:bold; box-shadow:0 2px 4px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<!-- SETUP SCREEN: User sets name and avatar -->
<div id="scr-setup" class="screen active">
    <div class="card">
        <h2>Profile</h2>
        <div class="grid-av" id="av-grid"></div>
        <input id="inp-name" placeholder="Your Name" style="text-align:center">
        <button class="btn" onclick="Setup()">Next</button>
    </div>
</div>

<!-- JOIN SCREEN: QR Scan or Manual ID entry -->
<div id="scr-join" class="screen">
    <div class="card">
        <h2>Join Class</h2>
        <div id="reader" style="border-radius:8px; overflow:hidden; margin-bottom:10px"></div>
        <button class="btn" onclick="StartScan()">üì∏ Scan QR</button>
        <input id="inp-id" placeholder="SESSION ID" style="text-align:center; text-transform:uppercase; margin-top:10px">
        <button class="btn btn-s" onclick="Connect($('inp-id').value)">Connect</button>
    </div>
</div>

<!-- LOBBY SCREEN: Main hub for sending notes and seeing status -->
<div id="scr-lobby" class="screen">
    <div style="width:100%; max-width:400px; display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
        <div style="font-weight:800; display:flex; gap:8px"><span id="my-av"></span><span id="my-name"></span></div>
        <div style="display:flex; gap:5px; align-items:center">
            <div id="status-badge" style="font-size:0.8rem; background:#bbf7d0; color:#166534; padding:4px 8px; border-radius:8px; transition:0.3s; font-weight:bold">Online</div>
            <button onclick="ManualDisconnect()" style="background:#fecaca; border:none; border-radius:50%; width:24px; height:24px; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#dc2626; font-size:0.8rem">‚úï</button>
        </div>
    </div>

    <!-- Active Zone Context: Appears when Teacher opens a specific zone -->
    <div id="active-zone-box" class="card" style="display:none; border:2px dashed #6366f1; background:#e0e7ff">
        <h3 style="color:#4338ca; margin-top:0">Target Zone</h3>
        <p id="zone-name" style="margin:0 0 10px 0; color:#6366f1">...</p>
        
        <!-- Default Zone Actions -->
        <div id="zone-btns-default">
            <button class="btn" style="background:#4f46e5" onclick="Draft('idea', State.draft.zoneId)">Add Note to Zone</button>
            <button class="btn" style="background:#818cf8" onclick="DraftSketch(State.draft.zoneId)">‚úèÔ∏è Sketch to Zone</button>
        </div>
        <!-- Claim-Evidence-Reasoning (CER) Specific Actions -->
        <div id="zone-btns-cer" style="display:none; display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px">
            <button class="btn" style="background:#d97706; font-size:0.9rem; padding:10px" onclick="Draft('claim', State.draft.zoneId)">Claim</button>
            <button class="btn" style="background:#0284c7; font-size:0.9rem; padding:10px" onclick="Draft('evidence', State.draft.zoneId)">Evidence</button>
            <button class="btn" style="background:#16a34a; font-size:0.9rem; padding:10px" onclick="Draft('reasoning', State.draft.zoneId)">Reasoning</button>
        </div>

        <button class="btn btn-s" style="margin-top:10px" onclick="ClearZone()">Cancel</button>
    </div>

    <!-- Open Note Contribution: Available when board is unlocked -->
    <div class="card" id="open-notes-box" style="display:none">
        <h3>General Contribution</h3>
        <div class="type-grid">
            <div class="type-btn" style="background:#fef3c7; border-color:#d97706" onclick="Draft('notice')"><span>üëÅÔ∏è</span>Notice</div>
            <div class="type-btn" style="background:#bae6fd; border-color:#0284c7" onclick="Draft('wonder')"><span>‚ùì</span>Wonder</div>
            <div class="type-btn" style="background:#bbf7d0; border-color:#16a34a" onclick="Draft('idea')"><span>üí°</span>Idea</div>
            <div class="type-btn" style="background:#fecaca; border-color:#dc2626" onclick="Draft('test')"><span>üß™</span>Test</div>
        </div>
        <button class="btn" style="margin-top:10px; background:#818cf8" onclick="DraftSketch(null)">‚úèÔ∏è New Sketch</button>
    </div>
    
    <!-- Locked State Message -->
    <div id="locked-msg" style="text-align:center; color:#94a3b8; margin:40px 0">
        <div style="font-size:3rem">üëÄ</div>
        <p>Look at the board...</p>
    </div>

    <!-- Local History of sent notes -->
    <div style="width:100%; max-width:400px; flex:1; display:flex; flex-direction:column">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
            <h4 style="margin:0; color:#64748b">Board History</h4>
            <button onclick="location.reload()" style="background:transparent; border:none; color:#94a3b8; font-size:1.2rem; cursor:pointer">‚Üª</button>
        </div>
        <div id="hist-list" style="flex:1; overflow-y:auto"></div>
    </div>
</div>

<!-- WRITE SCREEN: Text entry for notes -->
<div id="scr-write" class="screen">
    <div class="card">
        <h2 id="w-head">Note</h2>
        <div style="margin-bottom:10px; overflow-x:auto; white-space:nowrap; padding-bottom:5px">
             <span style="font-size:0.8rem; font-weight:bold; color:#64748b">CATEGORY:</span>
             <div class="type-grid" style="grid-template-columns:repeat(4, 1fr); gap:5px; margin-top:5px">
                <div class="type-btn" id="t-notice" style="padding:5px; font-size:0.8rem; background:#fef3c7; border-color:#d97706" onclick="SetDraftType('notice')">üëÅÔ∏è</div>
                <div class="type-btn" id="t-wonder" style="padding:5px; font-size:0.8rem; background:#bae6fd; border-color:#0284c7" onclick="SetDraftType('wonder')">‚ùì</div>
                <div class="type-btn" id="t-idea" style="padding:5px; font-size:0.8rem; background:#bbf7d0; border-color:#16a34a" onclick="SetDraftType('idea')">üí°</div>
                <div class="type-btn" id="t-test" style="padding:5px; font-size:0.8rem; background:#fecaca; border-color:#dc2626" onclick="SetDraftType('test')">üß™</div>
             </div>
        </div>
        <textarea id="w-txt" rows="5" placeholder="Type here..."></textarea>
        <button class="btn" onclick="SendNote()">Send</button>
        <button class="btn btn-s" onclick="Show('scr-lobby')">Cancel</button>
    </div>
</div>

<!-- SKETCH SCREEN: Canvas for drawing -->
<div id="scr-sketch" class="screen">
    <div class="card" style="max-width:500px">
        <h2 id="s-head">Draw Model</h2>
        <div class="tool-row">
            <div class="tool-btn active" onclick="SetTool('pen')" id="tb-pen">‚úèÔ∏è</div>
            <div class="tool-btn" onclick="SetTool('eraser')" id="tb-era">üßº</div>
            <div class="tool-btn" onclick="ClearSketch()" style="color:#ef4444">üóëÔ∏è</div>
        </div>
        <canvas id="sketch-canvas" width="300" height="300"></canvas>
        <input id="sketch-caption" placeholder="Add a caption..." style="margin-top:10px">
        <button class="btn" style="margin-top:15px" onclick="SendSketch()">Send Sketch</button>
        <button class="btn btn-s" onclick="Show('scr-lobby')">Cancel</button>
    </div>
</div>

<!-- WIDGET SCREEN: Interactive elements like Polls, Graphs, Voting -->
<div id="scr-widget" class="screen">
    <div class="card">
        <h2 id="wid-title" style="text-align:center; margin-bottom:20px">Activity</h2>
        
        <!-- VOTE/SORT CONTENT -->
        <div id="wid-content" style="flex:1; overflow-y:auto; padding:5px; display:flex; flex-direction:column; gap:10px; max-height:300px"></div>
        
        <!-- GRAPH INPUT -->
        <div id="wid-graph-input" style="display:none">
            <p style="color:#64748b">Enter your data point:</p>
            <input type="number" id="graph-val" placeholder="0.00" style="font-size:2rem; text-align:center">
        </div>

        <div style="background:var(--bg); padding-top:10px; z-index:100">
             <button class="btn" id="wid-btn" style="box-shadow:0 10px 20px rgba(99,102,241,0.3)">Submit</button>
        </div>
    </div>
</div>

<!-- EXIT TICKET SCREEN -->
<div id="scr-exit" class="screen">
    <div class="card">
        <h2 style="color:var(--accent)">Exit Ticket</h2>
        <p id="exit-prompt" style="font-size:1.1rem; color:#334155; margin-bottom:20px; font-weight:bold">...</p>
        
        <div id="exit-area">
            <!-- Dynamic Content -->
        </div>
        
        <button class="btn" id="exit-submit" style="margin-top:20px">Submit Response</button>
    </div>
</div>

<!-- DISCUSSION SCREEN: Threaded comments and reactions -->
<div id="scr-discuss" class="screen">
    <div style="width:100%; max-width:400px; display:flex; flex-direction:column; height:100%">
        <div class="disc-nav">
            <button class="btn-s" style="width:auto; padding:8px 16px; margin:0" onclick="DiscNav(-1)">‚¨ÖÔ∏è</button>
            <div class="disc-counter" id="disc-count">1 / 5</div>
            <button class="btn-s" style="width:auto; padding:8px 16px; margin:0" onclick="DiscNav(1)">‚û°Ô∏è</button>
        </div>
        
        <div id="disc-card-view" style="flex:1; display:flex; align-items:center; justify-content:center; margin-bottom:20px">
            <!-- Note Card Injected Here -->
        </div>

        <div class="card" style="margin-bottom:0">
            <h4 style="margin:0 0 10px 0; text-align:left; color:#64748b">Add to Discussion</h4>
            <textarea id="disc-txt" rows="2" placeholder="Your thoughts..."></textarea>
            <div class="disc-controls">
                <div class="disc-btn" onclick="DiscTag('support')">üõ°Ô∏è<br>Support</div>
                <div class="disc-btn" onclick="DiscTag('challenge')">‚öîÔ∏è<br>Challenge</div>
                <div class="disc-btn" onclick="DiscTag('build')">üß±<br>Build On</div>
                <div class="disc-btn" onclick="DiscTag('question')">‚ùì<br>Question</div>
            </div>
            <button class="btn" style="margin-top:15px" onclick="SendComment()">Post Comment</button>
        </div>
    </div>
</div>

<script>
/**
 * Utility: Short alias for document.getElementById
 * @param {string} id - The DOM element ID
 */
const $ = id => document.getElementById(id);

/**
 * Utility: Generates a short random alphanumeric ID
 */
const genId = () => Math.random().toString(36).substr(2, 9);

/**
 * Global State
 * Stores the user's profile, local note history, current draft status, active activities, and discussion state.
 */
const State = { 
    me: { name:'', av:'üòÄ' }, 
    notes: [], 
    draft: { id:null, sub:null, zoneId:null }, 
    act: null,
    exit: { val: null, multi: [], actId: null }, // Exit Ticket State
    discuss: { items:[], idx:0, tag:null },
    boardId: null, // Tracks the specific board we are connected to
    hostId: null,
    lastHeartbeat: 0
};

/**
 * Database Module (IndexedDB)
 * Persists user profile and sent notes so they survive page reloads.
 */
const DB = {
    db: null,
    init: () => new Promise(res => {
        const r = indexedDB.open('DQB_Student', 2); 
        r.onupgradeneeded = e => {
            const db = e.target.result;
            if(!db.objectStoreNames.contains('notes')) db.createObjectStore('notes', {keyPath:'id'});
            if(!db.objectStoreNames.contains('profile')) db.createObjectStore('profile', {keyPath:'key'});
        };
        r.onsuccess = e => { 
            DB.db = e.target.result; 
            const tx = DB.db.transaction(['profile','notes'], 'readonly');
            tx.objectStore('profile').get('me').onsuccess = ev => { if(ev.target.result) State.me = ev.target.result.val; };
            tx.objectStore('notes').getAll().onsuccess = ev => { State.notes = ev.target.result || []; };
            res();
        };
    }),
    saveNote: (n) => { 
        n.boardId = State.boardId; 
        const tx = DB.db.transaction('notes', 'readwrite'); 
        tx.objectStore('notes').put(n); 
        const idx = State.notes.findIndex(x=>x.id===n.id);
        if(idx >= 0) State.notes[idx] = n; else State.notes.push(n);
        RenderHist(); 
    },
    updateNote: (n) => { 
        // If the note doesn't have a boardId locally but exists, preserve it, otherwise adopt current
        const exist = State.notes.find(x=>x.id===n.id);
        if(exist) {
            n.boardId = exist.boardId || State.boardId;
            // Merge comments if present
            if(n.comments) exist.comments = n.comments;
        }
        const tx = DB.db.transaction('notes', 'readwrite'); 
        tx.objectStore('notes').put(n); 
        const idx = State.notes.findIndex(x=>x.id===n.id); 
        if(idx>=0) State.notes[idx]=n; 
        RenderHist(); 
    },
    delNote: (id) => { const tx = DB.db.transaction('notes', 'readwrite'); tx.objectStore('notes').delete(id); State.notes = State.notes.filter(x=>x.id!==id); RenderHist(); },
    saveProfile: () => DB.db.transaction('profile', 'readwrite').objectStore('profile').put({key:'me', val:State.me})
};

/* --- AVATAR SELECTION LOGIC --- */
const EMOJIS = ['üòÄ','üòé','ü¶ä','üê±','üöÄ','üé®','‚öΩ','ü¶Ñ','üçî','üß©'];
const g = $('av-grid');
EMOJIS.forEach(e => {
    let d = document.createElement('div'); d.className='av'; d.innerText=e;
    d.onclick = () => { document.querySelectorAll('.av').forEach(x=>x.classList.remove('sel')); d.classList.add('sel'); State.me.av=e; };
    g.appendChild(d);
});

/**
 * Saves profile data and moves to Join screen.
 */
function Setup() {
    State.me.name = $('inp-name').value || "Student";
    $('my-name').innerText = State.me.name; $('my-av').innerText = State.me.av;
    DB.saveProfile(); 
    
    // Check for previous session to auto-reconnect
    const lastHost = localStorage.getItem('dqb_host_id');
    if(lastHost) {
        Connect(lastHost);
    } else {
        Show('scr-join');
    }
}

/**
 * Screen Navigation Helper
 * @param {string} id - The ID of the screen div to show (e.g., 'scr-lobby')
 */
function Show(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); $(id).classList.add('active'); }

/**
 * Network Wrapper: SafeSend
 * Sends data via PeerJS only if connection is open.
 */
function SafeSend(data) { if(conn && conn.open) conn.send(JSON.stringify(data)); }

let peer, conn, hbInt;

/**
 * Starts the QR Code Scanner using Html5Qrcode library.
 * Stops automatically upon successful scan.
 */
function StartScan() { const s = new Html5Qrcode("reader"); s.start({ facingMode:"environment" }, { fps:10, qrbox:250 }, t => { s.stop(); Connect(t); }); }

/**
 * Connects to the Teacher/Host via PeerJS.
 * @param {string} id - The Host ID (scanned or typed)
 */
function Connect(id) {
    if(!id) return;
    id = id.trim();
    State.hostId = id;
    localStorage.setItem('dqb_host_id', id); // Session Persistence

    $('status-badge').innerText = "Connecting...";
    $('status-badge').style.background = "#fef3c7";
    $('status-badge').style.color = "#d97706";

    // Clean up existing peer if we are retrying
    if(peer) peer.destroy();
    
    peer = new Peer();
    
    peer.on('open', () => {
        // Initiate connection to Teacher
        conn = peer.connect(id);
        SetupConnectionEvents(conn);
    });

    // Handle Peer-Level Errors (e.g., Teacher ID not found)
    peer.on('error', (err) => {
        console.error(err);
        
        if(err.type === 'peer-unavailable') {
            // Teacher changed IDs or is offline
            localStorage.removeItem('dqb_host_id');
            $('status-badge').innerText = "Class not found";
            $('status-badge').style.background = "#fecaca";
            $('status-badge').style.color = "#dc2626";
            setTimeout(() => Show('scr-join'), 2000);
        } else {
            $('status-badge').innerText = "Net Error";
            setTimeout(() => Connect(State.hostId), 3000); // Retry loop
        }
    });

    // Start Heartbeat Monitor
    State.lastHeartbeat = Date.now();
    if(hbInt) clearInterval(hbInt);
    hbInt = setInterval(() => {
        // If silence for > 8 seconds, trigger restart
        if(Date.now() - State.lastHeartbeat > 8000) {
            console.warn("Heartbeat lost. Reconnecting...");
            $('status-badge').innerText = "Reconnecting...";
            $('status-badge').style.background = "#fef3c7";
            $('status-badge').style.color = "#d97706";
            
            // Force a full restart of the connection process
            Connect(State.hostId);
        }
    }, 2000);
}

function SetupConnectionEvents(connection) {
    connection.on('open', () => { 
        SafeSend({ type:'JOIN', name:State.me.name, avatar:State.me.av }); 
        State.lastHeartbeat = Date.now(); // Reset heartbeat on fresh connect
        $('status-badge').innerText = "Connected";
        $('status-badge').style.background = "#bbf7d0";
        $('status-badge').style.color = "#166534";
        Show('scr-lobby'); 
    });
    
    connection.on('data', (raw) => { 
        try { Handle(JSON.parse(raw)); } 
        catch(e) { console.error(e); } 
    });
    
    connection.on('close', () => { 
        // We don't manually reconnect here because the Heartbeat interval handles it
        $('status-badge').innerText = "Offline"; 
        $('status-badge').style.background = "#fecaca"; 
        $('status-badge').style.color = "#dc2626";
    });
}

function ManualDisconnect() {
    if(confirm("Leave this class?")) {
        if(conn) conn.close();
        localStorage.removeItem('dqb_host_id');
        location.reload();
    }
}

/**
 * Message Handler
 * Routes incoming messages from the Host to specific UI actions.
 * @param {object} d - The data packet received
 */
function Handle(d) {
    State.lastHeartbeat = Date.now(); // Update heartbeat on any message

    if(d.type === 'HEARTBEAT') {
        $('status-badge').innerText = "Connected";
        $('status-badge').style.background = "#bbf7d0";
        return; 
    }

    // Welcome: Teacher establishes which board session this is AND sends current board state
    if(d.type === 'WELCOME') {
        State.boardId = d.boardId;
        // Perform Offline Sync: Update local notes based on teacher's source of truth
        if(d.sync) SyncBoardState(d.sync);
        RenderHist(); // Re-render history to filter for this board
        
        // --- CRITICAL FIX: Handle active state immediately (Late Join/Refresh) ---
        if (d.payload) {
             Handle(d.payload); // Directly trigger the active widget/activity
        } else if (d.mode) {
             Handle({type:'MODE', val:d.mode}); // Fallback to mode handling
        }
    }

    // Mode Switching (Open Contribution vs Locked)
    else if(d.type==='MODE') {
        $('open-notes-box').style.display = d.val==='OPEN'?'block':'none';
        $('locked-msg').style.display = d.val==='OPEN'?'none':'block';
    }

    // Real-time Note Updates from Teacher (Edits/Type Changes)
    else if(d.type === 'NOTE_UPDATE') {
        const idx = State.notes.findIndex(n => n.id === d.note.id);
        if(idx !== -1) {
            d.note.boardId = State.notes[idx].boardId;
            DB.updateNote(d.note);
        }
    }

    // Teacher Comment on a note
    else if(d.type === 'COMMENT') {
        const idx = State.notes.findIndex(n => n.id === d.targetId);
        if(idx !== -1) {
            const note = State.notes[idx];
            if(!note.comments) note.comments = [];
            note.comments.push(d);
            DB.updateNote(note); // Triggers re-render which shows badge
        }
    }

    // Real-time Note Deletion by Teacher
    else if(d.type === 'DELETE_NOTE') {
        DB.delNote(d.id);
    }

    // Activity: Voting on items
    else if(d.type==='ACT_VOTE') {
        State.act = { id: d.actId, type: 'VOTE', sel: null };
        $('wid-title').innerText = "Vote for the Best";
        $('wid-content').style.display = 'flex'; $('wid-graph-input').style.display = 'none';
        $('wid-content').innerHTML = d.items.map(i => `<div class="note-card n-${i.sub||'meta'}" id="v-${i.id}" onclick="SelectVote('${i.id}')">${i.text}</div>`).join('');
        $('wid-btn').onclick = SubmitVote;
        Show('scr-widget');
    }
    // Activity: Drag and Drop Sorting
    else if(d.type==='ACT_SORT') {
        State.act = { id: d.actId, type: 'SORT', items: d.items };
        $('wid-title').innerText = "Rank Items (Drag)";
        $('wid-content').style.display = 'flex'; $('wid-graph-input').style.display = 'none';
        $('wid-content').innerHTML = d.items.map(i => `<div class="note-card n-${i.sub||'meta'}" draggable="true" data-id="${i.id}">${i.text} <span class="drag-h">‚â°</span></div>`).join('');
        InitDrag();
        $('wid-btn').onclick = SubmitSort;
        Show('scr-widget');
    }
    // Activity: Multiple Choice Poll
    else if(d.type==='ACT_POLL') {
        State.act = { id: d.actId, type: 'POLL', sel: null };
        $('wid-title').innerText = d.q;
        $('wid-content').style.display = 'flex'; $('wid-graph-input').style.display = 'none';
        $('wid-content').innerHTML = d.opts.map((o,i) => `<button class="btn btn-s" id="p-${i}" onclick="SelectPoll(${i})" style="text-align:left; font-size:1.1rem">${o.lbl}</button>`).join('');
        $('wid-btn').onclick = SubmitPoll;
        Show('scr-widget');
    }
    // Activity: Numerical Data Entry for Graphs
    else if(d.type==='ACT_GRAPH') {
        State.act = { id: d.actId, type: 'GRAPH' };
        $('wid-title').innerText = "Enter Data: " + d.title;
        $('wid-content').style.display = 'none';
        $('wid-graph-input').style.display = 'block';
        $('graph-val').value = '';
        $('wid-btn').onclick = SubmitGraph;
        Show('scr-widget');
    }
    // Activity: Discussion/Commenting
    else if(d.type==='ACT_DISCUSS') {
        State.discuss.items = d.items;
        State.discuss.idx = 0;
        RenderDiscuss();
        Show('scr-discuss');
    }
    // EXIT TICKET LAUNCH
    else if(d.type === 'EXIT_TICKET') {
        RenderExitTicket(d);
        Show('scr-exit');
    }
    else if(d.type === 'STOP_EXIT') {
        Show('scr-lobby');
        alert("Exit Ticket Closed");
    }
    // Zone Control: Teacher opened a zone for contribution
    else if(d.type==='OPEN_ZONE') {
        State.draft.zoneId = d.id;
        $('active-zone-box').style.display = 'block';
        $('zone-name').innerText = d.title;
        
        if(d.zoneType === 'cer') {
            $('zone-btns-default').style.display = 'none';
            $('zone-btns-cer').style.display = 'grid';
        } else {
            $('zone-btns-default').style.display = 'block';
            $('zone-btns-cer').style.display = 'none';
        }
    }
    // Zone Control: Teacher closed the zone
    else if(d.type==='CLOSE_ZONE') {
        $('active-zone-box').style.display = 'none';
        if(State.draft.zoneId === d.id) { State.draft.zoneId = null; }
    }
    // Activity Stop Command
    else if(d.type==='STOP_ACT') {
        Show('scr-lobby');
        alert("Activity Ended");
    }
}

/**
 * Compares local notes with the teacher's snapshot.
 * 1. If a local note is not in the server list, delete it.
 * 2. If a local note is in the server list, update it (content/type).
 */
function SyncBoardState(serverNotes) {
    const serverIds = new Set(serverNotes.map(n => n.id));

    // 1. Handle Deletions: Check every local note for this board
    State.notes.forEach(localNote => {
        if (localNote.boardId === State.boardId) {
            if (!serverIds.has(localNote.id)) {
                // Note was deleted on server
                DB.delNote(localNote.id);
            }
        }
    });

    // 2. Handle Updates: Check incoming notes against local
    serverNotes.forEach(srv => {
        const local = State.notes.find(n => n.id === srv.id);
        if (local) {
            // Note exists locally, update its content in case teacher edited it
            // We don't update sketches text (because it's just caption), only metadata
            // IMPORTANT: If srv.sub is sketch, it means it's an image note.
            if (srv.sub !== 'sketch') { 
                local.text = srv.text;
            }
            local.sub = srv.sub; // Update type (color)
            DB.updateNote(local);
        }
    });
}

/* --- EXIT TICKET LOGIC --- */
function RenderExitTicket(d) {
    $('exit-prompt').innerText = d.prompt || "Exit Ticket";
    const area = $('exit-area');
    area.innerHTML = '';
    State.exit.mode = d.mode;
    State.exit.actId = d.actId; // Store the Zone ID to reply to
    State.exit.val = null;
    State.exit.multi = [];

    if(d.mode === 'short') {
        area.innerHTML = `<textarea id="exit-txt" rows="6" placeholder="Your Answer..."></textarea>`;
        $('exit-submit').onclick = () => SubmitExit( $('exit-txt').value );
    } 
    else if (d.mode === 'smiley') {
        const emojis = ['üò°','üôÅ','üòê','üôÇ','üòÄ'];
        const row = document.createElement('div'); row.className='emoji-row';
        emojis.forEach(e => {
            const b = document.createElement('button'); b.className='emoji-btn'; b.innerText=e;
            b.onclick = () => { 
                document.querySelectorAll('.emoji-btn').forEach(x=>x.classList.remove('selected'));
                b.classList.add('selected');
                State.exit.val = e;
            };
            row.appendChild(b);
        });
        area.appendChild(row);
        $('exit-submit').onclick = () => SubmitExit(State.exit.val);
    }
    else if (d.mode === 'mc') {
        d.opts.forEach(o => {
            const b = document.createElement('div'); b.className='mc-btn'; b.innerText=o;
            b.onclick = () => {
                document.querySelectorAll('.mc-btn').forEach(x=>x.classList.remove('selected'));
                b.classList.add('selected');
                State.exit.val = o;
            };
            area.appendChild(b);
        });
        $('exit-submit').onclick = () => SubmitExit(State.exit.val);
    }
    else if (d.mode === 'multi') {
        d.opts.forEach(o => {
            const b = document.createElement('div'); b.className='mc-btn'; b.innerText=o;
            b.onclick = () => {
                b.classList.toggle('selected');
                if(b.classList.contains('selected')) State.exit.multi.push(o);
                else State.exit.multi = State.exit.multi.filter(x=>x!==o);
            };
            area.appendChild(b);
        });
        $('exit-submit').onclick = () => SubmitExit(State.exit.multi);
    }
    else if (d.mode === 'lw') {
        area.innerHTML = `
            <label style="font-weight:bold; color:#166534">One thing I Learned:</label>
            <input id="exit-l" placeholder="I learned...">
            <label style="font-weight:bold; color:#0369a1; margin-top:10px; display:block">One thing I Wonder:</label>
            <input id="exit-w" placeholder="I wonder...">
        `;
        $('exit-submit').onclick = () => {
            const l = $('exit-l').value; const w = $('exit-w').value;
            if(!l || !w) return alert("Please fill both fields");
            SubmitExit({ l:l, w:w });
        };
    }
}

function SubmitExit(val) {
    if(!val || (Array.isArray(val) && val.length===0)) return alert("Please enter a response.");
    // Send EXIT_SUBMIT with actId so teacher knows where to put it
    SafeSend({ type:'EXIT_SUBMIT', actId: State.exit.actId, val:val });
    $('exit-area').innerHTML = `<div style="text-align:center; padding:40px; color:#16a34a; font-weight:bold; font-size:1.5rem">Response Submitted!<br>‚úÖ</div>`;
    $('exit-submit').style.display='none';
}

/* --- DISCUSSION LOGIC --- */

/** Renders the current note card in discussion mode */
function RenderDiscuss() {
    const item = State.discuss.items[State.discuss.idx];
    $('disc-count').innerText = `${State.discuss.idx + 1} / ${State.discuss.items.length}`;
    $('disc-card-view').innerHTML = `
        <div class="note-card n-${item.sub||'meta'}" style="width:100%; height:100%; font-size:1.4rem; overflow-y:auto">
            ${item.text}
        </div>`;
    $('disc-txt').value = '';
    State.discuss.tag = null;
    document.querySelectorAll('.disc-btn').forEach(b => b.classList.remove('active'));
}

/** Navigates through discussion items (prev/next) */
function DiscNav(dir) {
    const len = State.discuss.items.length;
    State.discuss.idx = (State.discuss.idx + dir + len) % len;
    RenderDiscuss();
}

/** Sets the reaction tag (Support, Challenge, etc.) */
function DiscTag(tag) {
    State.discuss.tag = tag;
    document.querySelectorAll('.disc-btn').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
}

/** Sends the comment to the teacher */
function SendComment() {
    const txt = $('disc-txt').value;
    if(!txt) return alert("Write a comment first.");
    if(!State.discuss.tag) return alert("Select a reaction type (Support, Challenge, etc).");
    
    const item = State.discuss.items[State.discuss.idx];
    SafeSend({ 
        type: 'COMMENT', 
        targetId: item.id, 
        text: txt, 
        tag: State.discuss.tag,
        author: State.me.name 
    });
    alert("Comment Sent!");
    $('disc-txt').value = '';
}

/* --- ACTIVITY HELPERS --- */

function ClearZone() { $('active-zone-box').style.display='none'; State.draft.zoneId=null; }

// Voting Logic
function SelectVote(id) {
    State.act.sel = id;
    document.querySelectorAll('.note-card').forEach(e => e.classList.remove('selected'));
    $('v-'+id).classList.add('selected');
}
function SubmitVote() {
    if(!State.act.sel) return alert("Please select one.");
    SafeSend({ type:'SUBMIT_VOTE', actId:State.act.id, choiceId:State.act.sel });
    Show('scr-lobby');
}

// Poll Logic
function SelectPoll(idx) {
    State.act.sel = idx;
    document.querySelectorAll('#wid-content button').forEach(b => { b.style.background='#e2e8f0'; b.style.color='#475569'; });
    const b = $(`p-${idx}`); b.style.background='#6366f1'; b.style.color='white';
}
function SubmitPoll() {
    if(State.act.sel === null) return alert("Select an option.");
    SafeSend({ type:'POLL_VOTE', actId:State.act.id, idx:State.act.sel });
    Show('scr-lobby');
}

// Graph Logic
function SubmitGraph() {
    const v = parseFloat($('graph-val').value);
    if(isNaN(v)) return alert("Enter a valid number");
    SafeSend({ type:'DATA_SUBMIT', actId:State.act.id, val:v });
    Show('scr-lobby');
}

// Drag and Drop Logic for Sorting
function InitDrag() {
    const c = $('wid-content');
    let dragged = null;
    c.querySelectorAll('.note-card').forEach(el => {
        el.addEventListener('dragstart', () => { dragged = el; el.classList.add('dragging'); });
        el.addEventListener('dragend', () => { dragged = null; el.classList.remove('dragging'); });
        el.addEventListener('touchstart', (e) => { dragged = el; el.classList.add('dragging'); }, {passive:true});
        el.addEventListener('touchend', () => { dragged = null; el.classList.remove('dragging'); });
    });
    c.addEventListener('dragover', e => {
        e.preventDefault();
        const after = getDragAfterElement(c, e.clientY);
        if(after) c.insertBefore(dragged, after); else c.appendChild(dragged);
    });
}
function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.note-card:not(.dragging)')];
    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        return (offset < 0 && offset > closest.offset) ? { offset: offset, element: child } : closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}
function SubmitSort() {
    const order = [...$('wid-content').children].map(el => el.getAttribute('data-id'));
    SafeSend({ type:'SUBMIT_SORT', actId:State.act.id, order:order });
    Show('scr-lobby');
}

/* --- DRAFTING NOTES & SKETCHES --- */

/** Prepares the text editor */
function Draft(sub, zoneId=null) {
    State.draft = { id: genId(), sub: sub, zoneId: zoneId };
    $('w-txt').value = '';
    $('w-head').innerText = (zoneId ? "Zone Note" : "New Note");
    Show('scr-write');
}

/** Prepares the sketch editor */
function DraftSketch(zoneId) {
    State.draft = { id: genId(), sub: 'sketch', zoneId: zoneId };
    $('s-head').innerText = zoneId ? "Sketch for Zone" : "New Sketch";
    $('sketch-caption').value = '';
    Show('scr-sketch');
    InitSketch();
}

/** Loads an existing note into the editor */
function Edit(id) {
    const n = State.notes.find(x=>x.id===id); if(!n) return;
    if(n.sub === 'sketch') return alert("Cannot edit sketches");
    State.draft = { id: n.id, sub: n.sub, zoneId: null }; 
    $('w-txt').value = n.text;
    $('w-head').innerText = "Edit Note";
    Show('scr-write');
}

function SetDraftType(sub) { State.draft.sub = sub; UpdateEditorUI(); }

function UpdateEditorUI() {
    $('w-head').innerText = "Editing " + State.draft.sub.toUpperCase();
    document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('selected'));
    const btn = $(`t-${State.draft.sub}`); if(btn) btn.classList.add('selected');
}

/** Sends a text note to the Host */
function SendNote() {
    const txt = $('w-txt').value; if(!txt) return;
    const n = { id: State.draft.id, sub: State.draft.sub, text: txt, ts: Date.now(), boardId: State.boardId };
    DB.saveNote(n);
    SafeSend({ type:'NOTE', id:n.id, sub:n.sub, text:n.text, zoneId:State.draft.zoneId });
    Show('scr-lobby');
}

/** Sends a sketch image to the Host */
function SendSketch() {
    const canvas = $('sketch-canvas');
    // FIX: Compress to JPEG 0.5 to ensure payload fits in PeerJS data channel
    const data = canvas.toDataURL('image/jpeg', 0.5); 
    const cap = $('sketch-caption').value || 'Sketch';
    const n = { id: State.draft.id, sub: 'sketch', text: cap, src: data, ts: Date.now(), boardId: State.boardId };
    DB.saveNote(n);
    SafeSend({ type:'IMG_NOTE', id:n.id, src:data, text:cap, zoneId:State.draft.zoneId });
    Show('scr-lobby');
}

function Delete(id) { if(confirm("Delete?")) { DB.delNote(id); SafeSend({ type:'DELETE_NOTE', id:id }); } }
function Jiggle(id) { SafeSend({ type:'JIGGLE_NOTE', id:id }); }

/* --- SKETCH CANVAS LOGIC --- */
let ctx, isDrawing = false;
function InitSketch() {
    const cvs = $('sketch-canvas');
    const p = cvs.parentElement;
    cvs.width = p.clientWidth - 40; cvs.height = 300;
    ctx = cvs.getContext('2d');
    ctx.lineCap = 'round'; ctx.lineWidth = 3; ctx.strokeStyle = '#000';
    
    // Fill white background for JPEG export
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, cvs.width, cvs.height);
    
    const getPos = (e) => {
        const r = cvs.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
        return {x,y};
    }
    
    const start = (e) => { isDrawing=true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); };
    const move = (e) => { if(!isDrawing)return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); };
    const end = () => { isDrawing=false; };
    
    cvs.onmousedown = start; cvs.onmousemove = move; cvs.onmouseup = end;
    cvs.ontouchstart = start; cvs.ontouchmove = move; cvs.ontouchend = end;
}

function SetTool(t) {
    if(t==='pen') { ctx.globalCompositeOperation='source-over'; ctx.lineWidth=3; $('tb-pen').classList.add('active'); $('tb-era').classList.remove('active'); }
    else { ctx.globalCompositeOperation='destination-out'; ctx.lineWidth=20; $('tb-era').classList.add('active'); $('tb-pen').classList.remove('active'); }
}
function ClearSketch() { 
    ctx.clearRect(0,0,1000,1000); 
    ctx.fillStyle = "white"; 
    ctx.fillRect(0, 0, 1000, 1000); 
}

/** Renders the local history list of sent notes */
function RenderHist() {
    const c = $('hist-list');
    // Filter by Current Board ID.
    if (!State.boardId) {
        c.innerHTML = '<div style="text-align:center;color:#cbd5e1;padding:20px">Connect to a board to see your notes.</div>'; 
        return;
    }

    const filteredNotes = State.notes.filter(n => n.boardId === State.boardId);

    if(filteredNotes.length === 0) { c.innerHTML = '<div style="text-align:center;color:#cbd5e1;padding:20px">No notes on this board yet</div>'; return; }
    const sorted = [...filteredNotes].sort((a,b) => b.ts - a.ts);
    c.innerHTML = sorted.map(n => `
        <div class="hist-item note-card n-${n.sub}">
            ${n.comments && n.comments.length > 0 ? `<div class="badge-notify">${n.comments.length}</div>` : ''}
            ${n.sub==='sketch' ? `<img src="${n.src}" style="width:100%;border-radius:8px;background:white"><div style="font-size:0.9rem;margin-top:4px;color:#64748b">${n.text}</div>` : `<div style="white-space:pre-wrap">${n.text}</div>`}
            <div class="hist-bar">
                ${n.sub!=='sketch' ? `<button class="icon-btn" onclick="Edit('${n.id}')">‚úèÔ∏è Edit</button>` : ''}
                <button class="icon-btn" onclick="Jiggle('${n.id}')">üëã Wave</button>
                <button class="icon-btn" style="color:#ef4444" onclick="Delete('${n.id}')">üóëÔ∏è</button>
            </div>
        </div>
    `).join('');
}

// Auto-initialize DB on load, then check for profile to determine route
window.onload = () => {
    DB.init().then(() => {
        if (State.me.name) Setup();
    });
};
</script>
</body>
</html>