<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lumen Smartsheet Pro (Optimized)</title>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --primary-soft: #eef2ff;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --row-mod: #fff7ed;
            --row-new: #f0fdf4;
            --row-del: #fef2f2;
            --th-bg: #f8fafc;
            --row-h: 46px; /* FIXED ROW HEIGHT FOR VIRTUALIZATION */
        }

        [data-theme="dark"] {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-soft: #1e1b4b;
            --bg: #0f172a;
            --surface: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --row-mod: #422006;
            --row-new: #064e3b;
            --row-del: #450a0a;
            --th-bg: #0f172a;
        }

        body, html { height: 100%; width: 100%; background-color: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: var(--text-main); overflow: hidden; }
        
        /* Layout Structure */
        .view-section { display: none; height: 100dvh; width: 100vw; flex-direction: column; }
        .view-section.active { display: flex; }
        
        /* Dashboard Styles */
        #dashboardView { overflow-y: auto; }
        .hero-section { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); padding: 1.5rem; border-radius: 0 0 2rem 2rem; color: white; flex-shrink: 0; }
        .sheet-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; cursor: pointer; transition: 0.2s; }
        .sheet-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

        /* Editor Styles */
        .glass-header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; height: 60px; }
        .toolbar { background: var(--bg); border-bottom: 1px solid var(--border); padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; height: 50px; }
        
        /* Table Container - The Scrollable Area */
        .table-container { 
            flex: 1; 
            overflow: auto; 
            position: relative; 
            background: var(--surface);
            will-change: transform; /* Hint to browser for compositing */
        }

        /* Virtualization Spacers */
        #virtualTop, #virtualBottom { width: 100%; height: 0; }

        table { 
            border-collapse: separate; 
            border-spacing: 0; 
            table-layout: fixed; 
            width: max-content; 
            min-width: 100%; 
        }

        thead th { 
            background: var(--th-bg); 
            color: var(--text-muted); 
            font-size: 0.7rem; 
            font-weight: 700; 
            text-transform: uppercase; 
            padding: 0 8px; 
            height: 36px;
            border-bottom: 1px solid var(--border); 
            border-right: 1px solid var(--border); 
            position: sticky; 
            top: 0; 
            z-index: 10; 
            user-select: none;
            white-space: nowrap;
        }

        /* Sticky Columns */
        th:first-child, td:first-child { 
            position: sticky; 
            left: 0; 
            z-index: 20; 
            width: 50px; min-width: 50px; max-width: 50px; /* Reduced Action Column */
            border-right: 2px solid var(--border);
            background: var(--surface);
        }
        thead th:first-child { z-index: 30; background: var(--th-bg); }

        /* Rows & Cells */
        tbody tr { height: var(--row-h); }
        
        td { 
            border-bottom: 1px solid var(--border); 
            border-right: 1px solid var(--border); 
            padding: 0; 
            background: transparent;
            vertical-align: top;
        }

        /* High Performance Inputs */
        .cell-input {
            width: 100%; height: 100%;
            border: none; background: transparent;
            padding: 0 8px; font-family: inherit; font-size: 0.9rem;
            color: inherit; outline: none;
            display: flex; align-items: center;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .cell-input:focus { background: var(--surface); box-shadow: inset 0 0 0 2px var(--primary); }

        /* Conditional Styling */
        tr.row-mod td { background-color: var(--row-mod) !important; }
        tr.row-new td { background-color: var(--row-new) !important; }
        tr.row-del td { background-color: var(--row-del) !important; text-decoration: line-through; opacity: 0.6; }

        /* UI Elements */
        .tree-toggle { cursor: pointer; width: 20px; text-align: center; display: inline-block; user-select: none; }
        .tree-toggle.expanded i { transform: rotate(90deg); display: inline-block; }
        .tree-indent { display: inline-block; width: 16px; border-left: 1px dashed var(--border); height: 100%; vertical-align: middle; }
        
        .resizer { position: absolute; right: 0; top: 0; bottom: 0; width: 5px; cursor: col-resize; z-index: 50; }
        .resizer:hover { background: var(--primary); }

        /* Views Bar */
        .views-bar { background: var(--surface); border-bottom: 1px solid var(--border); display: flex; overflow-x: auto; flex-shrink: 0; height: 38px; }
        .view-tab { padding: 8px 16px; font-size: 0.85rem; cursor: pointer; border-bottom: 2px solid transparent; white-space: nowrap; }
        .view-tab.active { border-bottom-color: var(--primary); color: var(--primary); background: var(--primary-soft); }

        /* Utilities */
        .d-none { display: none !important; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        
        /* Action Menu */
        .action-cell-content { display: flex; justify-content: center; align-items: center; height: 100%; cursor: pointer; color: var(--text-muted); }
        .action-cell-content:hover { color: var(--primary); background: var(--primary-soft); }

        /* Badges */
        .badge-pill { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: var(--primary-soft); color: var(--primary-dark); margin-right: 2px; }
    </style>
</head>
<body>

<!-- DASHBOARD -->
<div id="dashboardView" class="view-section active">
    <div class="hero-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="fw-bold m-0"><i class="bi bi-grid-3x3-gap-fill me-2"></i>Lumen Sheet</h2>
            <button class="btn btn-sm btn-outline-light rounded-pill" onclick="toggleTheme()"><i class="bi bi-moon-stars-fill"></i></button>
        </div>
        <div class="d-flex gap-2 bg-white p-1 rounded-pill shadow-sm">
            <input type="text" id="dashSheetId" class="form-control border-0 rounded-pill ps-3 text-dark" placeholder="Enter Sheet ID...">
            <button class="btn btn-primary rounded-pill px-4" onclick="loadSheet(document.getElementById('dashSheetId').value)">Load</button>
        </div>
    </div>
    <div class="container mt-4">
        <h6 class="text-muted fw-bold small text-uppercase ls-1">Recent Sheets</h6>
        <div id="libraryGrid" class="row g-3 mt-1"></div>
    </div>
</div>

<!-- EDITOR -->
<div id="editorView" class="view-section">
    <!-- Header -->
    <div class="glass-header">
        <div class="d-flex align-items-center gap-3 overflow-hidden">
            <button class="btn btn-light rounded-circle border shadow-sm btn-sm" onclick="toDash()"><i class="bi bi-arrow-left"></i></button>
            <div style="min-width: 0;">
                <div class="fw-bold text-truncate" id="sheetName">Loading...</div>
                <div class="small text-muted font-monospace" id="sheetIdDisplay"></div>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="openSetup()"><i class="bi bi-sliders"></i> Columns</button>
        </div>
    </div>
    
    <!-- Toolbar -->
    <div class="toolbar">
        <div class="d-flex align-items-center gap-2 flex-grow-1">
            <div class="input-group input-group-sm" style="max-width: 250px;">
                <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                <input type="text" id="searchInput" class="form-control border-start-0" placeholder="Filter rows..." onkeyup="debounceSearch(this.value)">
            </div>
            <div id="syncStatus" class="small text-muted ms-2"></div>
        </div>
        <div class="d-flex align-items-center gap-2">
            <button id="btnDiscard" class="btn btn-sm btn-light border rounded-pill" onclick="discardChanges()" disabled>Discard</button>
            <button id="btnSync" class="btn btn-sm btn-primary rounded-pill fw-bold shadow-sm" onclick="sync()" disabled>
                Sync <span id="changeBadge" class="badge bg-white text-primary ms-1 rounded-pill" style="display:none">0</span>
            </button>
        </div>
    </div>

    <!-- Views -->
    <div class="views-bar" id="viewsContainer"></div>

    <!-- Main Table Area (Virtual Scroller) -->
    <div class="table-container" id="mainScrollContainer">
        <table id="mainTable">
            <thead id="tHead"></thead>
            <!-- Spacer Top -->
            <tr style="height: 0; padding: 0; border: none;"><td colspan="100" style="padding: 0; border: none;"><div id="virtualTop"></div></td></tr>
            <tbody id="tBody"></tbody>
            <!-- Spacer Bottom -->
            <tr style="height: 0; padding: 0; border: none;"><td colspan="100" style="padding: 0; border: none;"><div id="virtualBottom"></div></td></tr>
        </table>
    </div>
</div>

<!-- MODALS -->
<div class="modal fade" id="setupModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header border-0 pb-0"><h5 class="fw-bold">Column Setup</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div id="columnList" class="d-flex flex-column gap-2"></div></div><div class="modal-footer border-0"><button class="btn btn-primary w-100 rounded-pill" onclick="applyColumnVisibility()">Apply</button></div></div></div></div>
<div class="modal fade" id="tokenModal" tabindex="-1" data-bs-backdrop="static"><div class="modal-dialog"><div class="modal-content p-4"><h5 class="fw-bold">API Access</h5><p class="small text-muted">Enter Smartsheet Access Token</p><input type="password" id="apiToken" class="form-control mb-3"><button class="btn btn-primary w-100" onclick="saveToken()">Save</button></div></div></div>
<div id="loader" class="loading-overlay" style="display:none"><div class="spinner-border text-primary"></div></div>
<div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastArea"></div>

<!-- ACTION MENU (Context Menu Replaces Heavy Buttons) -->
<div id="ctxMenu" class="dropdown-menu shadow" style="display:none; position:fixed; z-index:9999;">
    <button class="dropdown-item" onclick="ctxAction('indent')"><i class="bi bi-text-indent-left me-2"></i>Indent</button>
    <button class="dropdown-item" onclick="ctxAction('outdent')"><i class="bi bi-text-indent-right me-2"></i>Outdent</button>
    <div class="dropdown-divider"></div>
    <button class="dropdown-item" onclick="ctxAction('addAbove')"><i class="bi bi-arrow-up me-2"></i>Add Row Above</button>
    <button class="dropdown-item" onclick="ctxAction('addBelow')"><i class="bi bi-arrow-down me-2"></i>Add Row Below</button>
    <div class="dropdown-divider"></div>
    <button class="dropdown-item text-danger" onclick="ctxAction('delete')"><i class="bi bi-trash me-2"></i>Delete Row</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/** 
 * PERFORMANCE ARCHITECTURE 
 * 1. Data Structure: Maps instead of Arrays for O(1) lookups.
 * 2. Virtualization: Only render what's visible.
 * 3. Flat List: Hierarchical tree is flattened into a display list once, then sliced for rendering.
 */

const CONFIG = { 
    proxy: "https://cors-anywhere.herokuapp.com/", 
    api: "https://api.smartsheet.com/2.0",
    rowHeight: 46, // Must match CSS var --row-h
    buffer: 5 // Extra rows to render above/below viewport
};

// --- GLOBAL STATE ---
let STATE = {
    sheetId: null,
    columns: [], // Array of Col definitions
    
    // Indexing for O(1) operations
    rowMap: new Map(), // ID -> Row Object
    childMap: new Map(), // ParentID -> Array of Row IDs
    roots: [], // Array of Top-level Row IDs
    
    // Changes
    edits: {}, // { rowId: { colId: val } }
    added: [], // Array of new row objects
    deleted: new Set(),
    moves: {}, // { rowId: { parentId: x, siblingId: y } }
    
    // UI State
    collapsed: new Set(),
    flatRenderList: [], // The linear list of rows currently visible (expanded & filtered)
    
    // View Config
    views: [],
    currentViewId: 'default',
    visibleColIds: new Set(),
    
    // Misc
    ctxRowId: null // Row ID for context menu
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    if(!localStorage.getItem('smToken')) new bootstrap.Modal('#tokenModal').show();
    renderLibrary();
    
    // Initialize Scroll Listener for Virtualization
    const scroller = document.getElementById('mainScrollContainer');
    scroller.addEventListener('scroll', () => requestAnimationFrame(renderVirtualTable));
    
    // Global Click to close menus
    document.addEventListener('click', (e) => {
        if(!e.target.closest('#ctxMenu') && !e.target.closest('.action-cell-content')) {
            document.getElementById('ctxMenu').style.display = 'none';
        }
    });
});

function saveToken() {
    localStorage.setItem('smToken', document.getElementById('apiToken').value);
    bootstrap.Modal.getInstance('#tokenModal').hide();
    renderLibrary();
}

async function api(ep, method='GET', body=null) {
    const t = localStorage.getItem('smToken');
    const opts = { method, headers: { 'Authorization': `Bearer ${t}`, 'Content-Type': 'application/json' } };
    if(body) opts.body = JSON.stringify(body);
    const res = await fetch(CONFIG.proxy + CONFIG.api + ep, opts);
    if(res.status === 403) { alert("Enable Proxy Demo"); window.open('https://cors-anywhere.herokuapp.com/corsdemo'); throw 'PROXY'; }
    if(!res.ok) throw await res.json();
    return await res.json();
}

// --- DATA LOADING & INDEXING (CRITICAL FOR PERFORMANCE) ---
async function loadSheet(id) {
    if(!id) return;
    document.getElementById('loader').style.display = 'flex';
    STATE.sheetId = id;
    
    try {
        const data = await api(`/sheets/${id}`);
        
        // Reset State
        STATE.columns = data.columns;
        STATE.rowMap.clear();
        STATE.childMap.clear();
        STATE.roots = [];
        STATE.edits = {};
        STATE.added = [];
        STATE.deleted.clear();
        STATE.moves = {};
        STATE.collapsed.clear();
        
        // Build Indexes O(N) once
        data.rows.forEach(r => {
            STATE.rowMap.set(r.id, r);
            const pid = r.parentId || 'ROOT';
            if(!STATE.childMap.has(pid)) STATE.childMap.set(pid, []);
            STATE.childMap.get(pid).push(r.id);
            if(!r.parentId) STATE.roots.push(r.id);
        });
        
        // Setup UI
        document.getElementById('sheetName').innerText = data.name;
        document.getElementById('sheetIdDisplay').innerText = data.id;
        document.getElementById('dashboardView').classList.remove('active');
        document.getElementById('editorView').classList.add('active');
        
        initViews(); // Default view
        recalcFlatList(); // Prepare data for virtualization
        renderTableHeader();
        renderVirtualTable(); // Initial Draw
        
        addToLib(id, data.name);
    } catch(e) {
        showToast(e.message || e, 'danger');
    } finally {
        document.getElementById('loader').style.display = 'none';
    }
}

// --- TREE FLATTENING (THE MAGIC SAUCE) ---
// Converts the hierarchical tree into a single flat array for the virtual scroller.
// Only runs when structure changes or filter changes.
function recalcFlatList() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const result = [];
    
    // Depth-First Traversal
    function traverse(rowIds, depth) {
        if(!rowIds) return;
        
        rowIds.forEach(rid => {
            const row = STATE.rowMap.get(rid);
            if(!row) return; // Deleted row logic handles this elsewhere, but safety check
            if(STATE.deleted.has(rid)) return;

            // Search Filter
            let matches = true;
            if(searchTerm) {
                // Simple search across all cell values
                const txt = row.cells.map(c => c.displayValue || c.value).join(' ').toLowerCase();
                if(!txt.includes(searchTerm)) matches = false;
                // Keep parents visible if children match? (Simplified: only show matching rows for performance)
            }

            if(matches) {
                result.push({ id: rid, depth: depth });
            }

            // Recurse if expanded
            // Note: If searching, we usually flatten everything or keep hierarchy. 
            // Here we respect collapse state unless searching.
            if(searchTerm || !STATE.collapsed.has(rid)) {
                traverse(STATE.childMap.get(rid), depth + 1);
            }
        });
    }

    traverse(STATE.roots, 0);
    STATE.flatRenderList = result;
    
    // Reset Scroll
    renderVirtualTable();
}

// --- VIRTUAL RENDERING ---
function renderVirtualTable() {
    const container = document.getElementById('mainScrollContainer');
    const scrollTop = container.scrollTop;
    const containerHeight = container.clientHeight;
    
    const totalRows = STATE.flatRenderList.length;
    const totalHeight = totalRows * CONFIG.rowHeight;
    
    // Calculate Indices
    let startIdx = Math.floor(scrollTop / CONFIG.rowHeight) - CONFIG.buffer;
    let endIdx = Math.ceil((scrollTop + containerHeight) / CONFIG.rowHeight) + CONFIG.buffer;
    
    // Clamp
    startIdx = Math.max(0, startIdx);
    endIdx = Math.min(totalRows, endIdx);
    
    // Set Spacers to fake the scroll height
    document.getElementById('virtualTop').style.height = `${startIdx * CONFIG.rowHeight}px`;
    document.getElementById('virtualBottom').style.height = `${(totalRows - endIdx) * CONFIG.rowHeight}px`;
    
    // Render the Slice
    const tbody = document.getElementById('tBody');
    const visibleRows = STATE.flatRenderList.slice(startIdx, endIdx);
    
    // Optimization: Reuse DOM elements? For simplicity in this file, we rebuild string. 
    // Since N is small (approx 30-40), innerHTML is fast enough here compared to 1000s.
    let html = '';
    
    visibleRows.forEach(meta => {
        const r = STATE.rowMap.get(meta.id);
        const isMod = STATE.edits[r.id] || STATE.moves[r.id];
        const isNew = String(r.id).startsWith('NEW');
        const cls = isNew ? 'row-new' : (isMod ? 'row-mod' : '');
        
        html += `<tr class="${cls}" data-id="${r.id}">`;
        
        // 1. Action Column (Sticky)
        html += `<td class="text-center bg-white border-end"><div class="action-cell-content" onclick="openCtxMenu(event, '${r.id}')"><i class="bi bi-three-dots"></i></div></td>`;
        
        // 2. Data Columns
        STATE.columns.forEach(c => {
            if(!STATE.visibleColIds.has(c.id)) return;
            
            // Get Value
            let val = '';
            if(STATE.edits[r.id] && STATE.edits[r.id][c.id] !== undefined) {
                val = STATE.edits[r.id][c.id];
            } else {
                const cell = r.cells.find(x => x.columnId === c.id);
                val = cell ? (cell.displayValue || cell.value || '') : '';
            }
            
            // Primary Column Indentation
            if(c.primary) {
                const hasChildren = STATE.childMap.get(r.id) && STATE.childMap.get(r.id).length > 0;
                const isCollapsed = STATE.collapsed.has(r.id);
                const indent = `<span class="tree-indent" style="margin-right: ${meta.depth * 16}px"></span>`;
                const toggle = hasChildren 
                    ? `<span class="tree-toggle ${isCollapsed ? '' : 'expanded'} me-1" onclick="toggleRow('${r.id}')"><i class="bi bi-caret-right-fill small"></i></span>` 
                    : `<span style="width:20px; display:inline-block"></span>`;
                    
                html += `<td><div class="d-flex align-items-center h-100 ps-1">${indent}${toggle}${renderCellInput(r.id, c, val)}</div></td>`;
            } else {
                html += `<td>${renderCellInput(r.id, c, val)}</td>`;
            }
        });
        
        html += `</tr>`;
    });
    
    tbody.innerHTML = html;
}

function renderCellInput(rid, col, val) {
    if(col.type === 'CHECKBOX') {
        const checked = val === true || val === 'true';
        return `<input type="checkbox" class="form-check-input m-auto d-block" ${checked?'checked':''} onchange="updateCell('${rid}', ${col.id}, this.checked)">`;
    }
    // Simple text for performance. Full Select/MultiSelect logic can be added here.
    return `<input class="cell-input" value="${String(val).replace(/"/g, '&quot;')}" onchange="updateCell('${rid}', ${col.id}, this.value)">`;
}

// --- COLUMN & HEADER ---
function renderTableHeader() {
    const thead = document.getElementById('tHead');
    let h = `<tr><th style="width:50px"></th>`; // Action Col
    STATE.columns.forEach(c => {
        if(STATE.visibleColIds.has(c.id)) {
            h += `<th style="width:${c.width || 150}px">${c.title}<div class="resizer" onmousedown="initResize(event, ${c.id})"></div></th>`;
        }
    });
    h += `</tr>`;
    thead.innerHTML = h;
}

function applyColumnVisibility() {
    const checks = document.querySelectorAll('#columnList input:checked');
    STATE.visibleColIds = new Set(Array.from(checks).map(c => parseInt(c.value)));
    renderTableHeader();
    renderVirtualTable(); // Refresh view
    bootstrap.Modal.getInstance('#setupModal').hide();
}

function openSetup() {
    const list = document.getElementById('columnList');
    list.innerHTML = '';
    STATE.columns.forEach(c => {
        const checked = STATE.visibleColIds.has(c.id) ? 'checked' : '';
        const dis = c.primary ? 'disabled checked' : '';
        list.innerHTML += `<div class="form-check"><input class="form-check-input" type="checkbox" value="${c.id}" ${checked} ${dis}><label class="form-check-label">${c.title}</label></div>`;
    });
    new bootstrap.Modal('#setupModal').show();
}

// --- INTERACTION LOGIC ---
function toggleRow(rid) {
    if(STATE.collapsed.has(rid)) STATE.collapsed.delete(rid);
    else STATE.collapsed.add(rid);
    recalcFlatList(); // Re-flatten tree
}

let searchTimer;
function debounceSearch(val) {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(() => recalcFlatList(), 300);
}

function updateCell(rid, cid, val) {
    if(!STATE.edits[rid]) STATE.edits[rid] = {};
    STATE.edits[rid][cid] = val;
    updateSyncStatus();
    // visual feedback
    const rowEl = document.querySelector(`tr[data-id="${rid}"]`);
    if(rowEl) rowEl.classList.add('row-mod');
}

// --- HIERARCHY / ROW MANIPULATION ---
function openCtxMenu(e, rid) {
    e.stopPropagation();
    STATE.ctxRowId = rid;
    const menu = document.getElementById('ctxMenu');
    menu.style.display = 'block';
    // Position check
    const mh = 200; // approx menu height
    let top = e.clientY;
    if (top + mh > window.innerHeight) top -= mh;
    menu.style.top = `${top}px`;
    menu.style.left = `${e.clientX}px`;
}

function ctxAction(action) {
    const rid = STATE.ctxRowId;
    if(!rid) return;
    
    // Move logic involves manipulating childMap and parent pointers
    if(action === 'indent') {
        // Find current parent
        const row = STATE.rowMap.get(rid);
        const currentSiblings = STATE.childMap.get(row.parentId || 'ROOT');
        const idx = currentSiblings.indexOf(rid);
        
        if(idx > 0) {
            const newParentId = currentSiblings[idx-1];
            moveRow(rid, newParentId);
        }
    } else if(action === 'outdent') {
        const row = STATE.rowMap.get(rid);
        if(row.parentId) {
            const grandParent = STATE.rowMap.get(row.parentId).parentId || 'ROOT';
            moveRow(rid, grandParent);
        }
    } else if (action === 'delete') {
        STATE.deleted.add(rid);
        // Recursively delete children visually
        const hideChildren = (pid) => {
            const kids = STATE.childMap.get(pid);
            if(kids) kids.forEach(k => { STATE.deleted.add(k); hideChildren(k); });
        };
        hideChildren(rid);
        updateSyncStatus();
        recalcFlatList();
    } else if (action === 'addBelow' || action === 'addAbove') {
         // Create New Row
         const newId = 'NEW_' + Date.now();
         const row = STATE.rowMap.get(rid);
         const pid = row.parentId || 'ROOT';
         
         const newRow = { 
             id: newId, 
             cells: [], 
             parentId: row.parentId,
             rowNumber: 9999 
         };
         
         STATE.rowMap.set(newId, newRow);
         STATE.added.push(newRow);
         if(!STATE.childMap.has(pid)) STATE.childMap.set(pid, []);
         
         const siblings = STATE.childMap.get(pid);
         const idx = siblings.indexOf(rid);
         const insertAt = action === 'addBelow' ? idx + 1 : idx;
         siblings.splice(insertAt, 0, newId);
         
         recalcFlatList();
         updateSyncStatus();
    }
    
    document.getElementById('ctxMenu').style.display = 'none';
}

function moveRow(rid, newPid) {
    const row = STATE.rowMap.get(rid);
    const oldPid = row.parentId || 'ROOT';
    
    // Remove from old
    const oldSibs = STATE.childMap.get(oldPid);
    const idx = oldSibs.indexOf(rid);
    if(idx > -1) oldSibs.splice(idx, 1);
    
    // Add to new
    if(!STATE.childMap.has(newPid)) STATE.childMap.set(newPid, []);
    STATE.childMap.get(newPid).push(rid);
    
    // Update Data
    row.parentId = newPid === 'ROOT' ? undefined : newPid;
    
    // Record Move for Sync
    STATE.moves[rid] = { parentId: row.parentId }; // Simplified for demo
    
    // If new parent was collapsed, expand it
    if(newPid !== 'ROOT') STATE.collapsed.delete(newPid);
    
    recalcFlatList();
    updateSyncStatus();
}

// --- SYNC ENGINE ---
function updateSyncStatus() {
    const cnt = Object.keys(STATE.edits).length + STATE.added.length + STATE.deleted.size + Object.keys(STATE.moves).length;
    const badge = document.getElementById('changeBadge');
    badge.innerText = cnt;
    badge.style.display = cnt > 0 ? 'inline-block' : 'none';
    document.getElementById('btnSync').disabled = cnt === 0;
    document.getElementById('btnDiscard').disabled = cnt === 0;
}

function discardChanges() {
    if(confirm("Discard all changes?")) loadSheet(STATE.sheetId);
}

async function sync() {
    document.getElementById('loader').style.display = 'flex';
    try {
        // 1. Deletes
        if(STATE.deleted.size > 0) {
            const ids = Array.from(STATE.deleted).filter(id => !String(id).startsWith('NEW')).join(',');
            if(ids) await api(`/sheets/${STATE.sheetId}/rows?ids=${ids}&ignoreRowsNotFound=true`, 'DELETE');
        }
        
        // 2. Adds
        if(STATE.added.length > 0) {
            const body = STATE.added.map(r => ({
                toBottom: true,
                parentId: r.parentId,
                cells: STATE.columns.map(c => ({ columnId: c.id, value: STATE.edits[r.id]?.[c.id] || null }))
            }));
            await api(`/sheets/${STATE.sheetId}/rows`, 'POST', body);
        }
        
        // 3. Updates (Edits & Moves)
        const updates = [];
        const updateIds = new Set([...Object.keys(STATE.edits), ...Object.keys(STATE.moves)]);
        
        updateIds.forEach(rid => {
            if(String(rid).startsWith('NEW') || STATE.deleted.has(rid)) return;
            const item = { id: parseInt(rid) };
            
            // Edits
            if(STATE.edits[rid]) {
                item.cells = Object.keys(STATE.edits[rid]).map(cid => ({ columnId: parseInt(cid), value: STATE.edits[rid][cid] }));
            }
            
            // Moves
            if(STATE.moves[rid]) {
                if(STATE.moves[rid].parentId) item.parentId = parseInt(STATE.moves[rid].parentId);
                else item.toTop = true; // or indent logic
            }
            updates.push(item);
        });
        
        if(updates.length) await api(`/sheets/${STATE.sheetId}/rows`, 'PUT', updates);
        
        showToast("Sync Complete", "success");
        loadSheet(STATE.sheetId); // Reload to get server state
        
    } catch(e) {
        showToast("Sync Failed: " + JSON.stringify(e), "danger");
        document.getElementById('loader').style.display = 'none';
    }
}

// --- UTILS ---
function initViews() {
    STATE.visibleColIds = new Set(STATE.columns.slice(0, 8).map(c => c.id));
    // Could load from localstorage here
}

function renderLibrary() {
    const lib = JSON.parse(localStorage.getItem('smLib') || '[]');
    const grid = document.getElementById('libraryGrid');
    grid.innerHTML = '';
    lib.forEach(s => {
        grid.innerHTML += `<div class="col-12 col-md-6 col-lg-4"><div class="sheet-card" onclick="loadSheet('${s.id}')"><div class="fw-bold text-truncate">${s.name}</div><div class="small text-muted font-monospace">${s.id}</div></div></div>`;
    });
}

function addToLib(id, name) {
    let lib = JSON.parse(localStorage.getItem('smLib') || '[]');
    lib = lib.filter(s => s.id !== id);
    lib.unshift({ id, name });
    localStorage.setItem('smLib', JSON.stringify(lib.slice(0,10)));
}

function toDash() {
    document.getElementById('editorView').classList.remove('active');
    document.getElementById('dashboardView').classList.add('active');
}

function toggleTheme() {
    const b = document.body;
    const curr = b.getAttribute('data-theme');
    b.setAttribute('data-theme', curr === 'dark' ? 'light' : 'dark');
}

function showToast(msg, type) {
    const el = document.createElement('div');
    el.className = `toast show align-items-center text-white bg-${type} border-0`;
    el.innerHTML = `<div class="d-flex"><div class="toast-body">${msg}</div><button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
    document.getElementById('toastArea').appendChild(el);
    setTimeout(()=>el.remove(), 3000);
}
</script>
</body>
</html>
